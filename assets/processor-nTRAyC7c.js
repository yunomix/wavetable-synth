var V=Object.defineProperty;var g=(E,o,f)=>o in E?V(E,o,{enumerable:!0,configurable:!0,writable:!0,value:f}):E[o]=f;var m=(E,o,f)=>g(E,typeof o!="symbol"?o+"":o,f);(function(){"use strict";class o extends AudioWorkletProcessor{constructor(){super();m(this,"channels");m(this,"voices");m(this,"sampleRateVal");this.channels=[];for(let n=0;n<16;n++){const s=new Float32Array(32);for(let t=0;t<32;t++)s[t]=Math.sin(t/32*2*Math.PI);this.channels.push({wavetable:s,adsr:{a:.1,d:.1,s:.5,r:.2}})}this.voices=[],this.voices=[];for(let n=0;n<64;n++)this.voices.push({active:!1,channel:0,note:0,phase:0,phaseStep:0,envState:"IDLE",envTime:0,envLevel:0,releaseStartLevel:0,velocity:0});this.sampleRateVal=sampleRate,this.port.onmessage=this.handleMessage.bind(this)}handleMessage(n){const{type:s,payload:t}=n.data;if(s==="NOTE_ON")this.triggerAttack(t.note,t.velocity,t.channel);else if(s==="NOTE_OFF")this.triggerRelease(t.note,t.channel);else if(s==="SET_CHANNEL_WAVETABLE"){const a=this.channels[t.channel];a&&t.wavetable.length===32&&a.wavetable.set(t.wavetable)}else if(s==="SET_CHANNEL_ADSR"){const a=this.channels[t.channel];a&&(a.adsr=t.adsr)}else s==="STOP_ALL"&&this.voices.forEach(a=>{a.active=!1,a.envState="IDLE",a.envLevel=0})}triggerAttack(n,s,t){let a=this.voices.find(A=>A.envState==="IDLE");a||(a=this.voices.find(A=>A.envState==="RELEASE")),a||(a=this.voices[0]),a.active=!0,a.note=n,a.channel=t;const L=440*Math.pow(2,(n-69)/12);a.phaseStep=L/this.sampleRateVal*32,a.phase=0,a.velocity=s/127,a.envState="ATTACK",a.envTime=0,a.envLevel=0}triggerRelease(n,s){this.voices.forEach(t=>{t.active&&t.note===n&&t.channel===s&&t.envState!=="RELEASE"&&t.envState!=="IDLE"&&(t.envState="RELEASE",t.envTime=0,t.releaseStartLevel=t.envLevel)})}process(n,s,t){const a=s[0],L=a[0],A=L.length;for(let h=0;h<A;h++){let T=0;for(const e of this.voices){if(!e.active)continue;const I=this.channels[e.channel],v=I.adsr,d=I.wavetable;if(e.channel===9){e.envTime++;const i=e.envTime/this.sampleRateVal;let c=0;if(e.note===35||e.note===36){const l=150*Math.exp(-i*20),r=Math.max(0,1-i*4);c=Math.sin(i*l*2*Math.PI)*r,r<=0&&(e.active=!1,e.envState="IDLE")}else if(e.note===38||e.note===40){const l=Math.max(0,1-i*8),r=Math.sin(i*180*2*Math.PI)*l*.5,p=Math.max(0,1-i*5),M=(Math.random()*2-1)*p;c=r+M,p<=0&&(e.active=!1,e.envState="IDLE")}else if(e.note>=42&&e.note<=46){const l=Math.max(0,1-i*30);c=(Math.random()*2-1)*l*.4,l<=0&&(e.active=!1,e.envState="IDLE")}else e.active=!1,e.envState="IDLE";T+=c*e.velocity*.8;continue}let S=0;switch(e.envState){case"ATTACK":const i=v.a*this.sampleRateVal;i<=0?(e.envLevel=1,e.envState="DECAY",e.envTime=0):(S=1/i,e.envLevel+=S,e.envLevel>=1&&(e.envLevel=1,e.envState="DECAY",e.envTime=0));break;case"DECAY":const c=v.d*this.sampleRateVal;c<=0?(e.envLevel=v.s,e.envState="SUSTAIN"):(S=(1-v.s)/c,e.envLevel-=S,e.envLevel<=v.s&&(e.envLevel=v.s,e.envState="SUSTAIN"));break;case"SUSTAIN":e.envLevel=v.s;break;case"RELEASE":const l=v.r*this.sampleRateVal;l<=0?(e.envLevel=0,e.active=!1,e.envState="IDLE"):(S=e.releaseStartLevel/l,e.envLevel-=S,e.envLevel<=0&&(e.envLevel=0,e.active=!1,e.envState="IDLE"));break}const u=e.envLevel*e.velocity;if(u>1e-4){const i=e.phase,c=Math.floor(i),l=i-c,r=(c+1)%32,p=d[c]*(1-l)+d[r]*l;T+=p*u,e.phase+=e.phaseStep,e.phase>=32&&(e.phase-=32)}}L[h]=T/8}for(let h=1;h<a.length;h++)a[h].set(L);return!0}}registerProcessor("wavetable-processor",o)})();
